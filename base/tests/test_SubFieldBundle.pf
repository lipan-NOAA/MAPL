module test_SubFieldBundle
   use ESMF
   use pfunit
   use ESMF_TestMethod_mod
   use MAPL_OpenMP_Support
   use MAPL_CubedSphereGridFactoryMod
   use MAPL_BaseMod
   implicit none


   type (ESMF_FieldBundle) :: trivial_bundle
   type (ESMF_FieldBundle) :: populated_bundle
   integer, parameter :: num_grids = 4
   integer, parameter :: num_fields = 3

   
contains


   @before
   subroutine setup(this)
      class(ESMF_TestMethod), intent(inout) :: this
      type(ESMF_Field) :: empty_list(0)
      integer :: status
      type(ESMF_Field) :: f_list(num_fields)
      character(len=2) :: field_name
      integer :: i

      trivial_bundle = ESMF_FieldBundleCreate(fieldList=empty_list, &
           & name='trivial', rc=status)
      @assert_that(status, is(0))
      do i=1,num_fields
         write(field_name,'(a1,i1)')"f",i
         f_list(i) = ESMF_FieldEmptyCreate(name=field_name,rc=status)
         @assertEqual(0,status)
      enddo
      populated_bundle = ESMF_FieldBUndleCreate(fieldList=f_list,name="foo",rc=status)
      @assertEqual(0,status)
     



   end subroutine setup

   function mock_make_subfields(field, num_grids, rc) result(fields)
      type(ESMF_Field), allocatable :: fields(:)
      type(ESMF_Field), intent(in) :: field
      integer, intent(in) :: num_grids
      integer, optional, intent(out) :: rc

      integer :: status,i
      character(len=ESMF_MAXSTR) :: name

      call ESMF_FieldGet(field, name=name,rc=status)
      @assert_that(status, is(0))
      allocate(fields(num_grids))
      do i=1,num_grids
         fields(i) = ESMF_FieldEmptyCreate(name=trim(name),rc=status)
         @assert_that(status, is(0))
      enddo
      if (present(rc)) rc=0
   end function mock_make_subfields

   @after
   subroutine teardown(this)
      class(ESMF_TestMethod), intent(inout) :: this
      integer :: status
      call ESMF_FieldBundleDestroy(trivial_bundle, rc=status)
      @assert_that(status, is(0))
   end subroutine teardown


   @test(npes=[6],type=newESMF_TestMethod)
   subroutine test_trivial_num_subfields(this)
      class(ESMF_TestMethod), intent(inout) :: this
      type(ESMF_FieldBundle), allocatable :: sub_bundles(:)
      integer :: status

      sub_bundles = make_subFieldBundles(trivial_bundle, num_grids=1, rc=status)
      @assert_that(status, is(0))
      @assert_that(size(sub_bundles), is(1))
     
      sub_bundles = make_subFieldbundles(trivial_bundle, num_grids=2, rc=status)
      @assert_that(status, is(0))
      @assert_that(size(sub_bundles), is(2))

   end subroutine test_trivial_num_subfields

   @test(npes=[6],type=newESMF_TestMethod)
   subroutine test_trivial_name(this)
      class(ESMF_TestMethod), intent(inout) :: this
      type(ESMF_FieldBundle), allocatable :: sub_bundles(:)
      character(ESMF_MAXSTR) :: found_name
      
      integer :: status

      sub_bundles = make_subFieldbundles(trivial_bundle, num_grids=num_grids, rc=status)
      @assert_that(status, is(0))
      @assert_that(size(sub_bundles), is(num_grids))

      call ESMF_FieldBundleGet(sub_bundles(1), name=found_name, rc=status)
      @assert_that(status, is(0))
      @assertEqual('trivial', found_name)
      
   end subroutine test_trivial_name


   @test(npes=[6],type=newESMF_TestMethod)
   subroutine test_trivial_num_fields(this)
      class(ESMF_TestMethod), intent(inout) :: this

      type(ESMF_FieldBundle), allocatable :: sub_bundles(:)
      integer :: status
      integer :: expected_field_count, found_field_count

      sub_bundles = make_subFieldbundles(trivial_bundle, num_grids=1, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldBundleGet(trivial_bundle, fieldcount=expected_field_count, rc=status)
      call ESMF_FieldBundleGet(sub_bundles(1), fieldcount=found_field_count, rc=status)

      @assert_that(status, is(0))
      @assert_that(found_field_count, is(expected_field_count))

   end subroutine test_trivial_num_fields

   @test(npes=[6],type=newESMF_TestMethod)
   subroutine test_populated_bundle(this)
      class(ESMF_TestMethod), intent(inout) :: this

      type(ESMF_FieldBundle), allocatable :: sub_bundles(:)
      integer :: status
      integer :: expected_field_count, found_field_count, i, j
      type(ESMF_Field), allocatable :: fields(:)
      type(ESMF_Field), allocatable :: subfields(:)
      character(ESMF_MAXSTR) :: fname,sub_fname
      character(ESMF_MAXSTR) :: bname,sub_bname

      sub_bundles = make_subFieldbundles(populated_bundle, num_grids=num_grids, make=mock_make_subfields, rc=status)
      @assert_that(status, is(0))
      @assert_that(size(sub_bundles),is(num_grids))

      call ESMF_FieldBundleGet(populated_bundle, fieldcount=expected_field_count, name=bname, rc=status)
      do i=1,size(sub_bundles)
         call ESMF_FieldBundleGet(sub_bundles(i), fieldcount=found_field_count, name=sub_bname, rc=status)
         @assert_that(status, is(0))
         @assert_that(found_field_count, is(expected_field_count))
         @assertequal(trim(bname),trim(sub_bname))
      enddo


      allocate(fields(expected_field_count))
      allocate(subfields(found_field_count))
      call ESMF_FieldBundleGet(populated_bundle,fieldList=fields,rc=status)
      @assert_that(status, is(0))


      do j=1,num_grids
         call ESMF_FieldBundleGet(sub_bundles(j),fieldList=subfields,rc=status)
         @assert_that(status, is(0))
         do i=1,size(fields)
            call ESMF_FieldGet(fields(i),name=fname,rc=status)
            call ESMF_FieldGet(subfields(i),name=sub_fname,rc=status)
            @assertequal(trim(fname),trim(sub_fname))
         enddo
      enddo

   end subroutine test_populated_bundle

end module test_SubFieldBundle
