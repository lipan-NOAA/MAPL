module test_SubField
   use ESMF
   use pfunit
   use ESMF_TestMethod_mod
   use MAPL_CubedSphereGridFactoryMod, only: CubedSphereGridFactory
   use MAPL_OpenMP_Support
   use mapl_MaplGrid

   implicit none

   type(ESMF_Grid), save  :: primary_grid

   type(ESMF_Field) :: f_2d_r4
   type(ESMF_Field) :: f_2d_r8
   type(ESMF_Field) :: f_3d_r4
   type(ESMF_Field) :: f_3d_r8

   type(ESMF_Field) :: f_2d_i4
   type(ESMF_Field) :: f_3d_i4
   real(kind=ESMF_KIND_R8), pointer :: lons(:,:), lats(:,:)
   real(kind=ESMF_KIND_R4), pointer :: ptr_2d_r4(:,:)
   real(kind=ESMF_KIND_R8), pointer :: ptr_2d_r8(:,:)
   real(kind=ESMF_KIND_R4), pointer :: ptr_3d_r4(:,:,:)
   real(kind=ESMF_KIND_R8), pointer :: ptr_3d_r8(:,:,:)
   integer(kind=ESMF_KIND_I4), pointer :: ptr_2d_i4(:,:)
   integer(kind=ESMF_KIND_I4), pointer :: ptr_3d_i4(:,:,:)

   integer, parameter :: IM = 5
   integer, parameter :: NX = 1

contains

   @before
   subroutine setup(this)
      class(ESMF_TestMethod), intent(inout) :: this
      type(CubedSphereGridFactory) :: cs_factory

      integer :: status, i, j
      integer :: local_count(3)
      
      cs_factory = CubedSphereGridFactory(im_world=im,nx=nx,ny=nx,lm=1,rc=status)
      @assertEqual(0,status)

      primary_grid = cs_factory%make_grid(rc=status)
      @assertEqual(0,status)

      call ESMF_GridGetCoord(grid=primary_grid, coordDim=1, localDE=0, &
           staggerloc=ESMF_STAGGERLOC_CENTER, farrayPtr=lons, rc=status)
      @assert_that(status, is(0))

      call ESMF_GridGetCoord(grid=primary_grid, coordDim=2, localDE=0, &
           staggerloc=ESMF_STAGGERLOC_CENTER, farrayPtr=lats, rc=status)
      @assert_that(status, is(0))

      call MAPL_GridGet(primary_grid,localcellcountPerDim=local_count, rc=status)
      @assertEqual(0,status)

      ! Set the coordinates to synthetic values that are easier to 
      ! test
      do j = 1, local_count(2) 
         do i = 1, local_count(1)
            lons(i,j) = j
            lats(i,j) = i
         end do
      end do


      f_2d_r4 = ESMF_FieldCreate(grid=primary_grid, typekind=ESMF_TYPEKIND_R4, &
           indexflag=ESMF_INDEX_DELOCAL, &
           staggerloc=ESMF_STAGGERLOC_CENTER, rc=status)
      @assert_that(status, is(0))

      f_2d_r8 = ESMF_FieldCreate(grid=primary_grid, typekind=ESMF_TYPEKIND_R8, &
           indexflag=ESMF_INDEX_DELOCAL, &
           staggerloc=ESMF_STAGGERLOC_CENTER, rc=status)
      @assert_that(status, is(0))

      f_3d_r4 = ESMF_FieldCreate(grid=primary_grid, typekind=ESMF_TYPEKIND_R4, &
           indexflag=ESMF_INDEX_DELOCAL, &
           ungriddedLBound=[1], ungriddedUBound=[5], &
           staggerloc=ESMF_STAGGERLOC_CENTER, rc=status)
      @assert_that(status, is(0))

      f_3d_r8 = ESMF_FieldCreate(grid=primary_grid, typekind=ESMF_TYPEKIND_R8, &
           indexflag=ESMF_INDEX_DELOCAL, &
           ungriddedLBound=[1], ungriddedUBound=[5], &
           staggerloc=ESMF_STAGGERLOC_CENTER, rc=status)
      @assert_that(status, is(0))

      f_2d_i4 =  ESMF_FieldCreate(grid=primary_grid, typekind=ESMF_TYPEKIND_I4, &
           indexflag=ESMF_INDEX_DELOCAL, &
           staggerloc=ESMF_STAGGERLOC_CENTER, rc=status)
      @assert_that(status, is(0))

      f_3d_i4 = ESMF_FieldCreate(grid=primary_grid, typekind=ESMF_TYPEKIND_I4, &
           indexflag=ESMF_INDEX_DELOCAL, &
           ungriddedLBound=[1], ungriddedUBound=[5], &
           staggerloc=ESMF_STAGGERLOC_CENTER, rc=status)
      @assert_that(status, is(0))
      
      call ESMF_FieldGet(f_2d_r4, localDe=0, farrayPtr=ptr_2d_r4, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(f_2d_r8, localDe=0, farrayPtr=ptr_2d_r8, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(f_3d_r4, localDe=0, farrayPtr=ptr_3d_r4, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(f_3d_r8, localDe=0, farrayPtr=ptr_3d_r8, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(f_2d_i4, localDe=0, farrayPtr=ptr_2d_i4, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(f_3d_i4, localDe=0, farrayPtr=ptr_3d_i4, rc=status)
      @assert_that(status, is(0))

      do j = 1, local_count(2)
         do i = 1, local_count(1)
            ptr_2d_r4(i,j) = f(i,j)
            ptr_2d_r8(i,j) = f(i,j)
            ptr_3d_r4(i,j,:) = f(i,j) 
            ptr_3d_r8(i,j,:) = f(i,j)
            ptr_2d_i4(i,j) = f(i,j)
            ptr_3d_i4(i,j,:) = f(i,j)
         end do
      end do
      call MAPL_GridGet(primary_grid,localcellcountPerDim=local_count, rc=status)
      @assertEqual(0,status)
   end subroutine setup

   real function f(i,j)
      integer, intent(in) :: i
      integer, intent(in) :: j

      f = i + 2 * j

   end function f

   @after
   subroutine teardown(this)
      class(ESMF_TestMethod), intent(inout) :: this
      integer :: status
      call ESMF_FieldDestroy(f_2d_r4, rc=status)
      @assert_that(status, is(0))
      call ESMF_FieldDestroy(f_2d_r8, rc=status)
      @assert_that(status, is(0))
      call ESMF_GridDestroy(primary_grid, rc=status)
      @assert_that(status, is(0))
   end subroutine teardown

   ! Starting with a simple Cubed-sphere grid, create a single
   ! local subgrid.  Verify that the local properties of the
   ! subgrid match the original grid.
   @test(npes=[6],type=newESMF_TestMethod)
   subroutine test_make_subField(this)
      class(ESMF_TestMethod), intent(inout) :: this
      integer :: status, num_grids
      type(ESMF_Grid), allocatable :: subgrids(:) 
      type(ESMF_Field), allocatable :: subfields(:)
      integer :: local_count(3)
      type(Interval), allocatable :: bounds(:)
      real(kind=ESMF_KIND_R4), pointer :: expected_2d_r4(:,:)
      real(kind=ESMF_KIND_R8), pointer :: expected_2d_r8(:,:)
      real(kind=ESMF_KIND_R4), pointer :: expected_3d_r4(:,:,:)
      real(kind=ESMF_KIND_R8), pointer :: expected_3d_r8(:,:,:)
      integer(kind=ESMF_KIND_I4), pointer :: expected_2d_i4(:,:)
      integer(kind=ESMF_KIND_I4), pointer :: expected_3d_i4(:,:,:)

      real(kind=ESMF_KIND_R4), pointer :: sub_ptr_2d_r4(:,:)
      real(kind=ESMF_KIND_R8), pointer :: sub_ptr_2d_r8(:,:)
      real(kind=ESMF_KIND_R4), pointer :: sub_ptr_3d_r4(:,:,:)
      real(kind=ESMF_KIND_R8), pointer :: sub_ptr_3d_r8(:,:,:)
      integer(kind=ESMF_KIND_I4), pointer :: sub_ptr_2d_i4(:,:)
      integer(kind=ESMF_KIND_I4), pointer :: sub_ptr_3d_i4(:,:,:)

      type(ESMF_FieldBundle) :: bundle
      type(ESMF_Field) :: fields(2)
      
      call MAPL_GridGet(primary_grid,localcellcountPerDim=local_count, rc=status)
      @assertEqual(0, status)

      num_grids = 1
      ! Synthetic bounds to choose a small subregion in the primary grid
      allocate(bounds(num_grids))
      bounds(1)%min = 2
      bounds(1)%max = 3

      subgrids = make_subgrids(primary_grid, bounds, status)

      ! check 
      call ESMF_GridGet(subgrids(1), rc=status)
      @assertEqual(0,status)

      ! As with make_subgrids() we first implement a lower level interface
      ! that assumes the subgrids are already available.
      ! the higher level overload will construct the actual subgrids and then
      ! call this lower level procedure.
   
      ! make subfields for 2d, r4 field and run tests
      subfields = make_subfields(f_2d_r4, subgrids, bounds, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(subfields(1), localDe=0, farrayPtr=sub_ptr_2d_r4, rc=status)
      @assert_that(status, is(0))

      expected_2d_r4 => ptr_2d_r4(:,bounds(1)%min:bounds(1)%max)
      @assert_that(sub_ptr_2d_r4, is(equal_to(expected_2d_r4)))


      ! make subfields for 2d, r8 field and run tests    
      subfields = make_subfields(f_2d_r8, subgrids, bounds, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(subfields(1), localDe=0, farrayPtr=sub_ptr_2d_r8, rc=status)
      @assert_that(status, is(0))

      expected_2d_r8 => ptr_2d_r8(:,bounds(1)%min:bounds(1)%max)
      @assert_that(sub_ptr_2d_r8, is(equal_to(expected_2d_r8)))


      ! make subfields for 3d, r4 field and run tests
      subfields = make_subfields(f_3d_r4, subgrids, bounds, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(subfields(1), localDe=0, farrayPtr=sub_ptr_3d_r4, rc=status)
      @assert_that(status, is(0))

      expected_3d_r4 => ptr_3d_r4(:,bounds(1)%min:bounds(1)%max,:)
      @assertEqual(expected_3d_r4, sub_ptr_3d_r4)


      ! make subfields for 3d, r8 field and run tests    
      subfields = make_subfields(f_3d_r8, subgrids, bounds, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(subfields(1), localDe=0, farrayPtr=sub_ptr_3d_r8, rc=status)
      @assert_that(status, is(0))

      expected_3d_r8 => ptr_3d_r8(:,bounds(1)%min:bounds(1)%max,:)
      @assertEqual(expected_3d_r8, sub_ptr_3d_r8)


      ! make subfields for 2d, i4 field and run tests
      subfields = make_subfields(f_2d_i4, subgrids, bounds, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(subfields(1), localDe=0, farrayPtr=sub_ptr_2d_i4, rc=status)
      @assert_that(status, is(0))

      expected_2d_i4 => ptr_2d_i4(:,bounds(1)%min:bounds(1)%max)
      @assertEqual(expected_2d_i4, sub_ptr_2d_i4)

      
      ! make subfields for 3d, i4 field and run tests
      subfields = make_subfields(f_3d_i4, subgrids, bounds, rc=status)
      @assert_that(status, is(0))

      call ESMF_FieldGet(subfields(1), localDe=0, farrayPtr=sub_ptr_3d_i4, rc=status)
      @assert_that(status, is(0))

      expected_3d_i4 => ptr_3d_i4(:,bounds(1)%min:bounds(1)%max,:)
      @assertEqual(expected_3d_i4, sub_ptr_3d_i4)

      ! creating a field bundle with the fields
      fields(1) = f_2d_r4
      fields(2) = f_2d_r8
      bundle = make_field_bundle(fields, status)
      @assert_that(status, is(0))

   end subroutine test_make_subField

end module test_SubField
